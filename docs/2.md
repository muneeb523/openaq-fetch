Absolutely, let's delve deeper into the integration of your DGM10 air quality sensor with the OpenAQ platform. This comprehensive guide will cover:

1. **Purpose and Objectives**
2. **System Architecture**
3. **Data Flow and Transformation**
4. **Adapter Implementation Details**
5. **Source Configuration**
6. **Testing and Validation**
7. **Deployment Considerations**
8. **Future Enhancements**

---

## 1. Purpose and Objectives

**Objective:** Integrate a locally hosted DGM10 air quality sensor with the OpenAQ platform to contribute real-time air quality data.

**Goals:**

* **Data Collection:** Gather air quality metrics such as gas concentrations, temperature, and humidity.
* **Data Transformation:** Convert sensor data into OpenAQ's standardized format.
* **Data Integration:** Seamlessly integrate transformed data into the OpenAQ ecosystem.

---

## 2. System Architecture

**Components:**

* **DGM10 Sensor:** Captures air quality data and serves it via a local HTTP endpoint (`http://192.168.0.196:8080/data.json`).
* **OpenAQ Fetch Adapter:** Custom adapter to fetch and transform sensor data.
* **OpenAQ Fetch Framework:** Processes data from various sources and integrates it into the OpenAQ platform.

**Workflow:**

1. **Data Retrieval:** The adapter fetches JSON data from the DGM10 sensor.
2. **Data Transformation:** The adapter converts the data into OpenAQ's format.
3. **Data Integration:** Transformed data is processed by the OpenAQ Fetch framework for integration.

---

## 3. Data Flow and Transformation

**Sensor Data Format:**

```json
{
  "sensor_ok": true,
  "led_enabled": true,
  "temperature_c": 24.56,
  "humidity_percent": 42.37,
  "s0": {
    "gas_concentration_ppm": 3.21,
    "range_ppm": 1000,
    "gas_type": 31,
    "gas_name": "Hydrogen Selenide (H2Se)",
    "status": "OK"
  },
  "s1": {
    "gas_concentration_ppm": 0.12,
    "range_ppm": 500,
    "gas_type": 34,
    "gas_name": "Oxygen (O2)",
    "status": "OK"
  }
}
```

**Transformation Logic:**

* **Validation:** Ensure `sensor_ok` is `true`.
* **Timestamping:** Assign current UTC and local timestamps.
* **Parameter Mapping:** Map `gas_name` to OpenAQ parameters (e.g., "Oxygen (O2)" to `o3`).
* **Measurement Construction:** Create measurement objects with fields like `parameter`, `value`, `unit`, `date`, `location`, `city`, `country`, and `coordinates`.

---

## 4. Adapter Implementation Details

**File Location:** `src/adapters/dgm10-local.js`

**Key Functions:**

* **Data Fetching:** Uses `request-promise-native` to retrieve JSON data from the sensor.
* **Data Parsing:** Extracts relevant fields from the JSON response.
* **Parameter Mapping:** Translates `gas_name` to OpenAQ standard parameters.
* **Measurement Creation:** Constructs measurement objects conforming to OpenAQ's schema.

**Example Code Snippet:**

```javascript
const request = require('request-promise-native');
const { DateTime } = require('luxon');

exports.name = 'dgm10-local';

exports.fetchData = async function (source, cb) {
  try {
    const response = await request({ uri: source.url, json: true });

    if (!response.sensor_ok) {
      return cb({ message: 'Sensor not OK' });
    }

    const datetimeUTC = DateTime.utc().toISO();
    const datetimeLocal = DateTime.local().toISO();
    const coordinates = source.coordinates;

    const baseMeta = {
      location: source.location,
      city: source.city,
      country: source.country,
      coordinates,
      attribution: [{ name: 'Your Project', url: 'https://yourproject.example.com' }],
      averagingPeriod: { value: 1, unit: 'hours' }
    };

    const measurements = [];

    for (const key in response) {
      if (key.startsWith('s') && response[key]?.gas_concentration_ppm !== undefined) {
        const sensor = response[key];
        const parameter = getParameterCode(sensor.gas_name);
        if (!parameter) continue;

        measurements.push({
          ...baseMeta,
          parameter,
          value: sensor.gas_concentration_ppm,
          unit: 'ppm',
          date: { utc: datetimeUTC, local: datetimeLocal }
        });
      }
    }

    measurements.push({
      ...baseMeta,
      parameter: 'temperature',
      value: response.temperature_c,
      unit: 'Â°C',
      date: { utc: datetimeUTC, local: datetimeLocal }
    });

    measurements.push({
      ...baseMeta,
      parameter: 'humidity',
      value: response.humidity_percent,
      unit: '%',
      date: { utc: datetimeUTC, local: datetimeLocal }
    });

    return cb(null, { name: exports.name, measurements });
  } catch (e) {
    return cb(e);
  }
};

function getParameterCode(gasName) {
  const lookup = {
    'Oxygen (O2)': 'o3',
    'Hydrogen Selenide (H2Se)': 'h2se'
  };
  return lookup[gasName] || null;
}
```

---

## 5. Source Configuration

**File Location:** `sources/in.json`

**Configuration Object:**

```json
{
  "name": "DGM10 Local Sensor",
  "adapter": "dgm10-local",
  "sourceURL": "http://192.168.0.196:8080/data.json",
  "url": "http://192.168.0.196:8080/data.json",
  "country": "IN",
  "city": "Delhi",
  "location": "My Home Sensor",
  "description": "Custom air quality sensor exposing JSON data from DGM10",
  "contacts": ["your-email@example.com"],
  "active": true,
  "type": "other",
  "license": "CC BY 4.0",
  "licenseURL": "https://creativecommons.org/licenses/by/4.0/",
  "mobile": false,
  "coordinates": {
    "latitude": 28.6139,
    "longitude": 77.2090
  }
}
```

**Notes:**

* Ensure the `coordinates` accurately represent the sensor's physical location.
* Update `contacts` with your actual contact information.

---

## 6. Testing and Validation

**Command:**

```bash
node scripts/cli.js --adapter dgm10-local
```

**Expected Output:**

```json
{
  "name": "dgm10-local",
  "measurements": [
    {
      "parameter": "h2se",
      "value": 3.21,
      ...
    },
    {
      "parameter": "o3",
      "value": 0.12,
      ...
    },
    {
      "parameter": "temperature",
      "value": 24.56,
      ...
    },
    {
     
::contentReference[oaicite:0]{index=0}
 
```
